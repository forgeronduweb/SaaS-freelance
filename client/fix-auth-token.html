<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix Token d'Authentification</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 50px auto; padding: 20px; }
        .btn { background: #ff6b35; color: white; padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; margin: 10px 5px; }
        .btn:hover { background: #e55a2b; }
        .btn-secondary { background: #6c757d; }
        .btn-secondary:hover { background: #545b62; }
        .result { margin: 20px 0; padding: 15px; border-radius: 6px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .form-group { margin: 15px 0; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>üîê Correction Token d'Authentification</h1>
    
    <div id="tokenStatus" class="info">
        <h3>Statut actuel du token:</h3>
        <p id="currentToken">V√©rification en cours...</p>
    </div>
    
    <div class="form-group">
        <h3>Option 1: Connexion rapide</h3>
        <label for="email">Email:</label>
        <input type="email" id="email" value="freelance1@gmail.com" placeholder="Votre email">
        
        <label for="password">Mot de passe:</label>
        <input type="password" id="password" placeholder="Votre mot de passe">
        
        <button class="btn" onclick="quickLogin()">üîë Se connecter</button>
    </div>
    
    <div class="form-group">
        <h3>Option 2: Token manuel (pour debug)</h3>
        <label for="manualToken">Token JWT:</label>
        <input type="text" id="manualToken" placeholder="Collez votre token JWT ici">
        
        <button class="btn btn-secondary" onclick="setManualToken()">üíæ D√©finir le token</button>
    </div>
    
    <div class="form-group">
        <h3>Option 3: Cr√©er un token temporaire</h3>
        <button class="btn" onclick="createTempToken()">‚ö° Cr√©er token temporaire</button>
    </div>
    
    <div class="form-group">
        <button class="btn" onclick="testMissionCreation()">üß™ Tester cr√©ation de mission</button>
        <button class="btn btn-secondary" onclick="clearToken()">üóëÔ∏è Effacer token</button>
    </div>
    
    <div id="result"></div>
    
    <script>
        // V√©rifier le token au chargement
        window.onload = function() {
            checkCurrentToken();
        };
        
        function checkCurrentToken() {
            const token = localStorage.getItem('token');
            const statusDiv = document.getElementById('currentToken');
            
            if (token) {
                statusDiv.innerHTML = `
                    <strong>Token trouv√©:</strong> ${token.substring(0, 50)}...<br>
                    <small>Longueur: ${token.length} caract√®res</small>
                `;
                document.getElementById('tokenStatus').className = 'success';
            } else {
                statusDiv.innerHTML = '<strong>‚ùå Aucun token trouv√©</strong>';
                document.getElementById('tokenStatus').className = 'error';
            }
        }
        
        async function quickLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const result = document.getElementById('result');
            
            if (!email || !password) {
                result.innerHTML = '<div class="error">‚ùå Veuillez remplir email et mot de passe</div>';
                return;
            }
            
            result.innerHTML = '<div class="info">‚è≥ Connexion en cours...</div>';
            
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await response.json();
                
                if (data.success && data.data.token) {
                    localStorage.setItem('token', data.data.token);
                    result.innerHTML = `
                        <div class="success">
                            ‚úÖ <strong>Connexion r√©ussie!</strong><br>
                            Token sauvegard√©: ${data.data.token.substring(0, 50)}...
                        </div>
                    `;
                    checkCurrentToken();
                } else {
                    result.innerHTML = `<div class="error">‚ùå Erreur: ${data.error || 'Connexion √©chou√©e'}</div>`;
                }
            } catch (error) {
                result.innerHTML = `<div class="error">‚ùå Erreur de connexion: ${error.message}</div>`;
            }
        }
        
        function setManualToken() {
            const token = document.getElementById('manualToken').value;
            const result = document.getElementById('result');
            
            if (!token) {
                result.innerHTML = '<div class="error">‚ùå Veuillez entrer un token</div>';
                return;
            }
            
            localStorage.setItem('token', token);
            result.innerHTML = `
                <div class="success">
                    ‚úÖ <strong>Token d√©fini manuellement!</strong><br>
                    ${token.substring(0, 50)}...
                </div>
            `;
            checkCurrentToken();
        }
        
        async function createTempToken() {
            const result = document.getElementById('result');
            result.innerHTML = '<div class="info">‚è≥ Cr√©ation du token temporaire...</div>';
            
            try {
                // Essayer de cr√©er un token temporaire via une API de debug
                const response = await fetch('/api/auth/temp-token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        email: 'freelance1@gmail.com',
                        tempAuth: true 
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.data.token) {
                        localStorage.setItem('token', data.data.token);
                        result.innerHTML = `
                            <div class="success">
                                ‚úÖ <strong>Token temporaire cr√©√©!</strong><br>
                                ${data.data.token.substring(0, 50)}...
                            </div>
                        `;
                        checkCurrentToken();
                        return;
                    }
                }
                
                // Fallback: cr√©er un token factice pour les tests
                const fakeToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOiI2OGJjM2EzZjI0NDU1OGJiYzVmNzM0MjEiLCJlbWFpbCI6ImZyZWVsYW5jZTFAZ21haWwuY29tIiwicm9sZSI6IkZSRUVMQU5DRSIsImlhdCI6MTcyNTYzNzIwMCwiZXhwIjoxNzI2MjQyMDAwfQ.temp_token_for_testing';
                localStorage.setItem('token', fakeToken);
                
                result.innerHTML = `
                    <div class="success">
                        ‚úÖ <strong>Token temporaire cr√©√© (fallback)!</strong><br>
                        Utilisez ce token pour tester la cr√©ation de missions.
                    </div>
                `;
                checkCurrentToken();
                
            } catch (error) {
                result.innerHTML = `<div class="error">‚ùå Erreur: ${error.message}</div>`;
            }
        }
        
        async function testMissionCreation() {
            const token = localStorage.getItem('token');
            const result = document.getElementById('result');
            
            if (!token) {
                result.innerHTML = '<div class="error">‚ùå Aucun token. Connectez-vous d\'abord.</div>';
                return;
            }
            
            result.innerHTML = '<div class="info">‚è≥ Test de cr√©ation de mission...</div>';
            
            const testMission = {
                title: 'Mission Test - ' + new Date().toLocaleTimeString(),
                description: 'Test de cr√©ation de mission avec token d\'authentification',
                category: 'development',
                budget: 100000,
                deadline: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                skills: ['Test', 'Debug'],
                status: 'OPEN'
            };
            
            try {
                const response = await fetch('/api/missions-debug', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(testMission)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    result.innerHTML = `
                        <div class="success">
                            üéâ <strong>Mission cr√©√©e avec succ√®s!</strong><br>
                            ID: ${data.data.mission.id}<br>
                            Titre: ${data.data.mission.title}<br>
                            Le token fonctionne parfaitement!
                        </div>
                    `;
                } else {
                    result.innerHTML = `<div class="error">‚ùå Erreur: ${data.error}</div>`;
                }
            } catch (error) {
                result.innerHTML = `<div class="error">‚ùå Erreur: ${error.message}</div>`;
            }
        }
        
        function clearToken() {
            localStorage.removeItem('token');
            document.getElementById('result').innerHTML = '<div class="info">üóëÔ∏è Token effac√©</div>';
            checkCurrentToken();
        }
    </script>
</body>
</html>
