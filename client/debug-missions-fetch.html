<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Missions Fetch</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
        .btn { background: #ff6b35; color: white; padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; margin: 10px 5px; }
        .btn:hover { background: #e55a2b; }
        .result { margin: 20px 0; padding: 15px; border-radius: 6px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .code { background: #f8f9fa; padding: 10px; border-radius: 4px; font-family: monospace; margin: 10px 0; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>üîç Debug R√©cup√©ration Missions</h1>
    
    <div class="info">
        <p>Cette page teste la r√©cup√©ration des missions cr√©√©es par un client sp√©cifique.</p>
    </div>
    
    <div>
        <label>Token d'authentification:</label>
        <input type="text" id="token" style="width: 100%; padding: 8px; margin: 10px 0;">
        <button class="btn" onclick="getTokenFromStorage()">üìã R√©cup√©rer du localStorage</button>
    </div>
    
    <div>
        <label>ID du client:</label>
        <input type="text" id="clientId" placeholder="ID du client" style="width: 100%; padding: 8px; margin: 10px 0;">
        <button class="btn" onclick="getUserFromToken()">üë§ R√©cup√©rer mon ID</button>
    </div>
    
    <button class="btn" onclick="testAllMissions()">üìã Toutes les missions</button>
    <button class="btn" onclick="testClientMissions()">üéØ Missions du client</button>
    <button class="btn" onclick="testDirectDB()">üóÑÔ∏è Test direct DB</button>
    
    <div id="result"></div>
    
    <script>
        function getTokenFromStorage() {
            const token = localStorage.getItem('token');
            if (token) {
                document.getElementById('token').value = token;
                showResult('‚úÖ Token r√©cup√©r√©', 'success');
            } else {
                showResult('‚ùå Aucun token trouv√©', 'error');
            }
        }
        
        async function getUserFromToken() {
            const token = document.getElementById('token').value;
            if (!token) {
                showResult('‚ùå Token requis', 'error');
                return;
            }
            
            try {
                // D√©coder le token JWT pour r√©cup√©rer l'ID utilisateur
                const payload = JSON.parse(atob(token.split('.')[1]));
                document.getElementById('clientId').value = payload.userId;
                showResult(`‚úÖ ID utilisateur: ${payload.userId}<br>Email: ${payload.email}<br>R√¥le: ${payload.role}`, 'success');
            } catch (error) {
                showResult(`‚ùå Erreur d√©codage token: ${error.message}`, 'error');
            }
        }
        
        async function testAllMissions() {
            showResult('‚è≥ Test toutes les missions...', 'info');
            
            try {
                const response = await fetch('/api/missions?limit=100');
                const result = await response.json();
                
                if (response.ok) {
                    showResult(`‚úÖ ${result.data.missions.length} missions trouv√©es:<br><div class="code">${JSON.stringify(result, null, 2)}</div>`, 'success');
                } else {
                    showResult(`‚ùå Erreur: ${result.error}`, 'error');
                }
            } catch (error) {
                showResult(`‚ùå Erreur: ${error.message}`, 'error');
            }
        }
        
        async function testClientMissions() {
            const token = document.getElementById('token').value;
            const clientId = document.getElementById('clientId').value;
            
            if (!token || !clientId) {
                showResult('‚ùå Token et ID client requis', 'error');
                return;
            }
            
            showResult('‚è≥ Test missions du client...', 'info');
            
            try {
                const response = await fetch(`/api/missions?clientId=${clientId}&limit=100`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    const missions = result.data?.missions || [];
                    showResult(`‚úÖ ${missions.length} missions trouv√©es pour le client:<br><div class="code">${JSON.stringify(result, null, 2)}</div>`, 'success');
                } else {
                    showResult(`‚ùå Erreur: ${result.error}<br><div class="code">${JSON.stringify(result, null, 2)}</div>`, 'error');
                }
            } catch (error) {
                showResult(`‚ùå Erreur: ${error.message}`, 'error');
            }
        }
        
        async function testDirectDB() {
            showResult('‚è≥ Test direct en base...', 'info');
            
            try {
                const response = await fetch('/api/debug-missions-count');
                const result = await response.json();
                
                if (response.ok) {
                    showResult(`‚úÖ Statistiques base:<br><div class="code">${JSON.stringify(result, null, 2)}</div>`, 'success');
                } else {
                    showResult(`‚ùå Erreur: ${result.error}`, 'error');
                }
            } catch (error) {
                showResult(`‚ùå Erreur: ${error.message}`, 'error');
            }
        }
        
        function showResult(message, type) {
            const result = document.getElementById('result');
            result.innerHTML = `<div class="${type}">${message}</div>`;
        }
        
        window.onload = function() {
            getTokenFromStorage();
        };
    </script>
</body>
</html>
